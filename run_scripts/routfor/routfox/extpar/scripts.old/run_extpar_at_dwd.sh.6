#!/bin/ksh

# ---  run_extpar_at_dwd.sh --- #

########################################################################
#                                                                      #
#  generate EXTernal PARameters for ICON                               #
#                                                                      #
#  call:         run_extpar_at_dwd.sh            \                     #
#                  -dir_grid=${dir_grid}         \                     #
#                  -info_grid=${info_grid}                             #
#                                                                      #
#                                                                      #
#  parameters:   -dir_grid   - directory of the ICON grid file         #
#                              default is  ROUTINE_DIR_IGLO_EXT        #
#  routine_config | fgrep -i ROUTINE_DIR_IGLO_EXT                      #       
#                -info_grid  - ICON grid base (e.g. 0026_R03B07_G)     #
#                -work_dir   - working directory (optional)            #
#                                                                      #
#  example: run_extpar_at_dwd.sh -dir_grid=${filename}          \      #
#                                 -info_grid=${info_grid}              #
#                                                                      #
#  modified by:  J. Helmert from extpar_cosmo_routi.sh by Ch. Koziar   #
#                                                                      #
#  last change: 2019/06/13  by  J. Helmert                             #
#                                                                      #
########################################################################
#                                                                      #
#  Modifications:                                                      #
#  --------------                                                      #
#                                                                      #
#  2019/06/13  -  First version                                        #
#  2019/10/14  -  Add notes for stand-alone version in user env        #
#                                                                      #
########################################################################

# To create an own copy of the EXTPAR environment:
# 1. copy the content of ~routfor/routfox/extpar to an own directory, e.g. ${HOME}/OWN_EXTPAR
# 2. Adapt below in the script EXTPAR_HOME=${HOME}/OWN_EXTPAR
# 3. For using own binaries of EXTPAR point below in the script PROGDIR_LC to the location of the EXTPAR binaries
# 4. Ensure that the correct names of the binaries are used, i.e. 
#       modify the content of FileNames in the ADM workbench (remove prefix ->tst-<, add suffix ->.new<-):
# BINARIES    = $(STDROOT)/extpar_aot_to_buffer.new \
#               $(STDROOT)/extpar_consistency_check.new \
#               $(STDROOT)/extpar_cru_to_buffer.new \
#               $(STDROOT)/extpar_flake_to_buffer.new \
#               $(STDROOT)/extpar_landuse_to_buffer.new \
#               $(STDROOT)/extpar_ndvi_to_buffer.new \
#               $(STDROOT)/extpar_soil_to_buffer.new \
#               $(STDROOT)/extpar_alb_to_buffer.new \
#               $(STDROOT)/extpar_topo_to_buffer.new \
#               $(STDROOT)/extpar_ahf_to_buffer.new \
#               $(STDROOT)/extpar_isa_to_buffer.new \
#               $(STDROOT)/extpar_emiss_to_buffer.new \
#               $(STDROOT)/extpar_sgsl_to_buffer.new

# exit on error:
set -e

module load cdo
module load nco

error_count=0
run_command()
{
    set +e
    echo ">> Run ${1%% *} ..."    
    start=$(date +%s.%N)
    eval qsubw  $1 > ${logfile} 2>&1 
    rc=$?
    printf "   Return code: %i\n" $rc
    end=$(date +%s.%N)
    runtime=$(bc -l <<< "$end - $start")
    if (( rc > 0 ))
    then
        (( error_count++ ))
    fi 
    case $rc in
        0)
            echo "   SUCCESS ${1%% *}" 
            echo "   LOGFILE is $2"
            ;;
        127)
            echo "   ERROR ${1%% *}: command not found"
            echo "   LOGFILE is $2"
            ;;
        *)
            echo "   ERROR ${1%% *}: fatal error - return code $rc"
            echo "   LOGFILE is $2"
            ;;
    esac
    echo "   execution time: $runtime s"
    [[ -f ${logfile} ]] && cat ${logfile}
    [[ -f $2 ]] && cat $2
    set -e

    # @ckoziar, 20190926:
    if (( rc != 0 )) ; then
        exit ${rc}
    fi
}

scriptpath=$0
scriptname=${scriptpath##*/}
logfile=${scriptname%.*}_$(date +%Y%m%d%H%M%S).log


eval $(routine_config)

# ------------------------------------------------ #
# ---  help variables to print error masseges  --- #
# ------------------------------------------------ #
typeset          name=${0##*/} ; name=${name%.ne[uw]}
typeset          cn="${name}:"
typeset -L${#cn} bn=''
typeset -u       NAME=${name}

# ------------------------ #
# ---  usage function  --- #
# ------------------------ #
function usage { print "usage: ${name} -h" ; }

# ---------------------------------------------- #
# ---  parameter test - simple               --- #
# ---  (OPTIND: next parameter to evaluate)  --- #
# ---------------------------------------------- #
typeset    argstring="$@"

integer    errflag=0
typeset    errparm=''
typeset    ECHO=''

typeset    xopt=''

typeset    fflag=''
typeset    Dflag=''

typeset    logdir=${TMPDIR}

if (( errflag == 1 )) ; then
  print "${cn} parameter error (${errparm})  -  usage: ${name} -h" >&2
  exit 201
fi

# ---------------------------------------------- #
# ---  parameter test - extended             --- #
# ---  (OPTIND: next parameter to evaluate)  --- #
# ---------------------------------------------- #
typeset    argstring="$@"
typeset    arg_array
set -A     arg_array -- "$@"

integer    errflag=0
typeset    errparm=''
typeset    ECHO=''

typeset    dir_grid=$ROUTINE_DIR_IGLO_EXT
typeset    info_grid=''
typeset    work_dir=''

while getopts d:i:hw: option ; do
  case ${option} in
        d) # dir_grid
        optarg=${OPTARG}
        case ${optarg%%=*} in
          ir_grid) if [[ "${arg_array[$((${OPTIND}-2))]%%=*}" == "-${option}${optarg%%=*}" ]] ; then
                       if [[ ":${optarg%%=*}" == ":${optarg}" ]] ; then
                         dir_grid="${arg_array[$((${OPTIND}-1))]}"
                         OPTIND=$((${OPTIND} + 1))
                       else
                         dir_grid="${OPTARG#*=}"
                       fi
                     fi
                     ;;
           *)        errflag=1
                     ;;
        esac  
;;
     h) scr_info $0
        exit 0
        ;;
      i) # info_grid
        optarg=${OPTARG}
        case ${optarg%%=*} in
          nfo_grid) if [[ "${arg_array[$((${OPTIND}-2))]%%=*}" == "-${option}${optarg%%=*}" ]] ; then
                       if [[ ":${optarg%%=*}" == ":${optarg}" ]] ; then
                         info_grid="${arg_array[$((${OPTIND}-1))]}"
                         OPTIND=$((${OPTIND} + 1))
                       else
                         info_grid="${OPTARG#*=}"
                       fi
                     fi
                     ;;
           *)        errflag=1
                     ;;
        esac
        ;;
        w) # work_dir
        optarg=${OPTARG}
        case ${optarg%%=*} in
          ork_dir) if [[ "${arg_array[$((${OPTIND}-2))]%%=*}" == "-${option}${optarg%%=*}" ]] ; then
                       if [[ ":${optarg%%=*}" == ":${optarg}" ]] ; then
                         work_dir="${arg_array[$((${OPTIND}-1))]}"
                         OPTIND=$((${OPTIND} + 1))
                       else
                         work_dir="${OPTARG#*=}"
                       fi
                     fi
                     ;;
           *)        errflag=1
                     ;;
        esac  
;;
    \?) errflag=1
        ;;
  esac
  if (( errflag == 1 )) ; then
    eval errparm=\"\${$((${OPTIND}-1))}\"
    break
  fi
done
shift $((${OPTIND} - 1))

if [[ -z "${info_grid}" ]] ; then
  print "${cn} parameter error - usage: ${name} -h" >&2
  exit 201
fi

if [[ "${dir_grid}" == "${ROUTINE_DIR_IGLO_EXT}" && \
      ! -f ${dir_grid}/${info_grid} ]] ; then
   info_grid=icon_grid_${info_grid}.nc
fi

if [[ ! -f ${dir_grid}/${info_grid} ]] ; then
  print "${cn} parameter error - no corresponding grid file found (${dir_grid}/${info_grid})." >&2
  exit 201
fi

logdir=${work_dir:-${TMPDIR}}

###################################################################################################


# @ckoziar, 20190806:
# TODAY=$(date  +%Y%m%d)
TODAY=$(date '+%s')

ICON_GRID=${info_grid}
PROGDIR_LC=/usr/local/pkg/for0adm/abs/
GRIDDIR=${dir_grid}
EXTPAR_HOME=~routfor/routfox/extpar
TMP=${TMPDIR}
# @ckoziar, 20190806:
# WORKDIR=$TMP/${ICON_GRID}_${TODAY}
WORKDIR=${work_dir:-${TMP}/${ICON_GRID}_${TODAY}_$$}
print ">>>  Settings:"
print ">>>  dir_grid=${dir_grid}"
print ">>>  info_grid=${info_grid}"
print ">>>  progdir_lc=${PROGDIR_LC}"
print ">>>  extpar_home=${EXTPAR_HOME}"
print ">>>  tmp=${TMP}"
print ">>>  workdir=${WORKDIR}"

if (( errflag == 1 )) ; then
  print "${cn} parameter error (${errparm})  -  usage: ${name} -h" >&2
  exit 201
fi

# @jhelmert/ckoziar, 20191022:
# check for minimum and maximum latitude in case of ASTER orography:
if [[ -s ${GRIDDIR}/${ICON_GRID} ]] ; then
  meshsize_km=$(ncks -M ${GRIDDIR}/${ICON_GRID} | \
                awk '/grid_root/  { GRIDROOT=$NF  }
                     /grid_level/ { GRIDLEVEL=$NF }
                     END { print(5050./(GRIDROOT*2**GRIDLEVEL))}
                    ' -
               )
  min_lat_vert=$(cdo infov ${GRIDDIR}/${ICON_GRID} | \
                 grep -i latitude_vertices | awk '{ print $9 * 180. / atan2(0, -1) }')
  max_lat_vert=$(cdo infov ${GRIDDIR}/${ICON_GRID} | \
                 grep -i latitude_vertices | awk '{ print $11 * 180. / atan2(0, -1) }')

  print -- "mesh size of '${GRIDDIR}/${ICON_GRID}': ${meshsize_km} km"
  print -- "minimum latitude of vertices in '${GRIDDIR}/${ICON_GRID}': ${min_lat_vert} deg"
  print -- "maximum latitude of vertices in '${GRIDDIR}/${ICON_GRID}': ${max_lat_vert} deg"

  if (( meshsize_km < 3.0 )) ; then
    # switch from GLOBE to ASTER orography for resolutions higher than 3.0 km:
    print -- "switch to ASTER orography because target horizontal resolution is higher than 3.0 km"
    if (( max_lat_vert > 60.0 )) ; then
      echo "ERROR: ASTER orography is not available above 60degN"
      exit 202
    fi
    if (( min_lat_vert < -60.0 )) ; then
      echo "ERROR: ASTER orography is not available below 60degS"
      exit 202
    fi
  fi
fi

echo "cd $TMP"
cd $TMP

# cat > igrid <<EOF
# ${ICON_GRID}
# EOF
# cat > igrid_dir <<EOF
# ${GRIDDIR}
# EOF
# cat > iwork_dir <<EOF
# ${WORKDIR}
# EOF
# cat > progdir_lc <<EOF
# ${PROGDIR_LC}
# EOF
# cat > progdir_xc <<EOF
# ${PROGDIR_XC}
# EOF

###############################################################################################
echo "Step 1/5 for grid ${ICON_GRID} ... Prepare EXTPAR environment in $WORKDIR"
sed -e "s:%igrid%:${ICON_GRID}:g
        s:%igrid_dir%:${GRIDDIR}:g
        s:%iwork_dir%:${WORKDIR}:g
        s:%progdir_lc%:${PROGDIR_LC}:g
        s:%loggingfile%:${logdir}/o.extpar_icon.extpar_prep.$$.log:g
       " ${EXTPAR_HOME}/job/extpar_prep.sh > extpar_prep.$$.sh && \
run_command extpar_prep.$$.sh ${logdir}/o.extpar_icon.extpar_prep.$$.log
echo "Step 1/5 for grid ${ICON_GRID} ... Prepare EXTPAR environment in $WORKDIR ... finished"
###############################################################################################


###############################################################################################
echo "Step 2/5 for grid ${ICON_GRID} ... Start scripts for parameter from ERA-I "
echo "${ICON_GRID} ... Start scripts for parameter from ERA-I ... SST2ICON"
sed -e "s:%igrid%:${ICON_GRID}:g
        s:%igrid_dir%:${GRIDDIR}:g
        s:%iwork_dir%:${WORKDIR}:g
        s:%loggingfile%:${logdir}/o.extpar_icon.dwd-monmean-sst2icon.$$.log:g
       " ${EXTPAR_HOME}/job/dwd-monmean-sst2icon.sh > dwd-monmean-sst2icon.$$.sh && \
run_command dwd-monmean-sst2icon.$$.sh ${logdir}/o.extpar_icon.dwd-monmean-sst2icon.$$.log
if [[ ! -s ${WORKDIR}/ei_an1986-2015_${ICON_GRID%.nc}_BUFFER.nc ]]; then
   icon_grid=${ICON_GRID%.nc} ; icon_grid=${icon_grid#icon_grid_} ; 
   if [[ ! -s ${WORKDIR}/ei_an1986-2015_${icon_grid}_BUFFER.nc ]]; then
      echo "$0 error: ${WORKDIR}/ei_an1986-2015_${icon_grid}_BUFFER.nc is missing, something was going wrong before ..."
      exit
   fi
fi
echo "Step 2/5 for grid ${ICON_GRID} ... Scripts for parameter from ERA-I ... SST2ICON ... finished"
###############################################################################################



###############################################################################################
echo "Step 3/5 for grid ${ICON_GRID} ... Start scripts for parameter from ERA-I ... T2M2ICON"
sed -e "s:%igrid%:${ICON_GRID}:g
        s:%igrid_dir%:${GRIDDIR}:g
        s:%iwork_dir%:${WORKDIR}:g
        s:%loggingfile%:${logdir}/o.extpar_icon.dwd-monmean-t2m2icon.$$.log:g
       " ${EXTPAR_HOME}/job/dwd-monmean-t2m2icon.sh > dwd-monmean-t2m2icon.$$.sh && \
run_command dwd-monmean-t2m2icon.$$.sh ${logdir}/o.extpar_icon.dwd-monmean-t2m2icon.$$.log
if [[ ! -s ${WORKDIR}/ei_2t_an1986-2015_${ICON_GRID%.nc}_BUFFER.nc ]]; then
   icon_grid=${ICON_GRID%.nc} ; icon_grid=${icon_grid#icon_grid_} ; 
   if [[ ! -s ${WORKDIR}/ei_2t_an1986-2015_${icon_grid}_BUFFER.nc ]]; then
      echo "$0 error: ${WORKDIR}/ei_2t_an1986-2015_${icon_grid}_BUFFER.nc is missing, something was going wrong before ..."
      exit
   fi
fi
echo "Step 3/5 for grid ${ICON_GRID} ... Scripts for parameter from ERA-I ... T2M2ICON ... finished"
###############################################################################################



###############################################################################################
logfile4zip=external_parameter_icon_${ICON_GRID%.nc}_tiles.extpar.log
echo "Step 4/5 for grid ${ICON_GRID} ... Start EXTPAR modules"
sed -e "s:%igrid%:${ICON_GRID}:g
        s:%igrid_dir%:${GRIDDIR}:g
        s:%iwork_dir%:${WORKDIR}:g
        s:%progdir_lc%:${PROGDIR_LC}:g
        s:%loggingfile%:${logdir}/o.extpar_icon.extpar_modules.$$.log:g
        s:%logfile4zip%:${logdir}/${logfile4zip}:g
       " ${EXTPAR_HOME}/job/extpar_modules.sh > extpar_modules.$$.sh && \
run_command extpar_modules.$$.sh ${logdir}/o.extpar_icon.extpar_modules.$$.log
echo "Step 4/5 for grid ${ICON_GRID} ... EXTPAR modules ... finished"
###############################################################################################


###############################################################################################
echo "Step 5/5 for grid ${ICON_GRID} ... Checking EXTPAR file and converting to GRIB2"
[[ -s ${WORKDIR}/external_parameter_icon_${ICON_GRID%.nc}_tiles.nc ]] || echo "EXTPAR file is external_parameter_icon_${ICON_GRID%.nc}_tiles.nc in ${WORKDIR}"
if [[ ! -s ${WORKDIR}/external_parameter_icon_${ICON_GRID%.nc}_tiles.nc ]]; then
   icon_grid=${ICON_GRID%.nc} ; icon_grid=${icon_grid#icon_grid_} ; 
   if [[ ! -s ${WORKDIR}/external_parameter_icon_${icon_grid}_tiles.nc ]]; then
      echo "$0 error: ${WORKDIR}/external_parameter_icon_${icon_grid}_tiles.nc is missing, something was going wrong before ..."
      exit
   fi
fi
sed -e "s:%igrid%:${ICON_GRID}:g
        s:%iwork_dir%:${WORKDIR}:g
        s:%loggingfile%:${logdir}/o.extpar_icon.extpar2grib2.$$.log:g
       " ${EXTPAR_HOME}/job/extpar2grib2.sh > extpar2grib2.$$.sh && \
run_command extpar2grib2.$$.sh ${logdir}/o.extpar_icon.extpar2grib2.$$.log
[[ -s ${WORKDIR}/external_parameter_icon_${ICON_GRID%.nc}_tiles.g2 ]] || echo "EXTPAR file in GRIB2 is external_parameter_icon_${ICON_GRID%.nc}_tiles.g2 in ${WORKDIR}"
if [[ ! -s ${WORKDIR}/external_parameter_icon_${ICON_GRID%.nc}_tiles.nc ]]; then
   icon_grid=${ICON_GRID%.nc} ; icon_grid=${icon_grid#icon_grid_} ; 
   if [[ ! -s ${WORKDIR}/external_parameter_icon_${icon_grid}_tiles.nc ]]; then
      echo "$0 error: ${WORKDIR}/external_parameter_icon_${icon_grid}_tiles.g2 is missing, something was going wrong before ..."
      exit
   fi
fi
echo "Step 5/5 for grid ${ICON_GRID} ... Checking EXTPAR file and converting to GRIB2 ... finished"
###############################################################################################
